## 需求
1. 支持两人对战
2. 登录首页后，通过输入房间号来匹配，如果输入的房间号一样则开始对战
3. 房间号设置简单的六位数


## 任务
1. 实现需求的功能
2. 将实现的过程总结到 “实现”的章节

## 实现

### 技术方案
使用 **Socket.IO** 实现稳定的实时多人游戏：
- ✅ 稳定的客户端-服务器连接
- ✅ 自动重连和错误处理
- ✅ 房间管理和状态同步
- ✅ 实时双向通信
- ✅ 支持多种部署方式

### 核心组件

#### 1. 类型定义 (`src/types/multiplayer.ts`)
- `Room`: 房间信息结构
- `MultiplayerGameState`: 扩展游戏状态
- `GameMessage`: 消息传递格式
- 各种消息类型：`MoveMessage`, `RestartMessage`, `UndoMessage`

#### 2. Socket.IO 连接管理 (`src/hooks/useSocketIO.ts`)
**功能：**
- 初始化 Socket.IO 连接
- 创建房间（成为房主）
- 加入房间（成为客人）
- 管理连接状态和重连
- 发送/接收消息
- 处理准备状态同步

**核心方法：**
```typescript
- initializeSocket(): 初始化Socket.IO连接
- createRoom(): 创建房间，返回房间ID
- joinRoom(roomId): 连接到指定房间
- sendMessage(message): 发送游戏消息
- sendPlayerReady(): 发送准备就绪信号
- disconnect(): 断开连接
```

#### 3. 多人游戏逻辑 (`src/hooks/useMultiplayerGame.ts`)
**功能：**
- 扩展单人游戏逻辑支持多人模式
- 处理回合制约束（只能在自己回合下棋）
- 同步游戏状态
- 处理对手消息

**核心特性：**
- 房主执黑子（先手），客人执白子（后手）
- 只允许在自己回合下棋
- 实时同步棋盘状态
- 悔棋需要撤销双方各一步

#### 4. 房间大厅界面 (`src/components/RoomLobby.tsx`)
**功能：**
- 显示用户ID和连接状态
- 创建房间或输入房间ID加入
- 显示玩家角色（房主/客人，黑子/白子）
- 连接状态指示器

#### 5. 多人游戏页面 (`src/app/multiplayer/page.tsx`)
**功能：**
- 集成房间大厅和游戏界面
- 管理游戏流程（大厅 → 游戏 → 结果）
- 显示多人专属控制面板
- 回合提示和权限控制

#### 6. 主菜单升级 (`src/app/page.tsx`)
**功能：**
- 游戏模式选择（单人/多人）
- 模式间切换
- 游戏规则说明

### 游戏流程

#### 房间创建流程
1. 用户点击"创建房间" 
2. 服务器生成6位随机房间号（如：123456）
3. 房主连接到服务器，房间状态管理在服务端
4. 房主等待客人加入，显示6位房间号供分享
5. 房主执黑子，可以准备就绪

#### 房间加入流程  
1. 用户输入6位房间号（如：123456）
2. 系统验证格式后向服务器发送加入请求
3. 服务器验证房间存在且未满，客人加入成功
4. 客人执白子，可以准备就绪

#### 游戏进行流程
1. 双方都准备就绪后，服务器自动开始游戏
2. 黑子（房主）先手
3. 每次下棋后通过服务器转发消息给对手
4. 系统验证回合正确性和棋步有效性
5. 实时同步棋盘状态

#### 消息传递协议
```typescript
// 下棋消息
{
  type: 'move',
  data: { row: number, col: number, player: 'black'|'white' },
  timestamp: number,
  playerId: string
}

// 重新开始
{
  type: 'restart',
  data: {},
  timestamp: number,
  playerId: string  
}

// 悔棋（撤销双方各一步）
{
  type: 'undo', 
  data: {},
  timestamp: number,
  playerId: string
}
```

### 技术亮点

1. **稳定连接**: 使用Socket.IO确保稳定的客户端-服务器连接
2. **简化房间号**: 使用6位数字房间号，便于记忆和分享
3. **状态同步**: 服务器统一管理房间状态，确保数据一致性
4. **回合制控制**: 严格的回合验证，防止非法操作
5. **连接管理**: 自动重连、错误处理和状态恢复
6. **权限分离**: 房主和客人有不同的操作权限
7. **实时反馈**: 连接状态、准备状态、游戏进度实时显示
8. **输入验证**: 房间号格式验证，只允许6位纯数字
9. **自动重试**: 连接失败时支持指数退避重试机制
10. **准备机制**: 双方都准备就绪后自动开始游戏

### 部署特性
- 支持 Node.js 服务器部署
- 可部署到 Heroku、Railway、Vercel 等支持 Node.js 的平台
- 支持自定义 Socket.IO 服务器配置
- 支持生产环境的负载均衡和扩展
