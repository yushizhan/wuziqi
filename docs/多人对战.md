## 需求
1. 支持两人对战
2. 登录首页后，通过输入房间号来匹配，如果输入的房间号一样则开始对战
3. 房间号设置简单的六位数


## 任务
1. 实现需求的功能
2. 将实现的过程总结到 “实现”的章节

## 实现

### 技术方案
选择了轻量级的 **PeerJS** 解决方案，实现点对点（P2P）连接：
- ✅ 无需自建后端服务器
- ✅ 无需数据库存储
- ✅ 使用免费的信令服务器
- ✅ 纯前端解决方案
- ✅ 实时数据传输

### 核心组件

#### 1. 类型定义 (`src/types/multiplayer.ts`)
- `Room`: 房间信息结构
- `MultiplayerGameState`: 扩展游戏状态
- `GameMessage`: 消息传递格式
- 各种消息类型：`MoveMessage`, `RestartMessage`, `UndoMessage`

#### 2. P2P连接管理 (`src/hooks/useMultiplayer.ts`)
**功能：**
- 初始化 PeerJS 连接
- 创建房间（成为房主）
- 加入房间（成为客人）
- 管理连接状态
- 发送/接收消息

**核心方法：**
```typescript
- initializePeer(): 初始化PeerJS实例
- createRoom(): 创建房间，返回房间ID
- joinRoom(roomId): 连接到指定房间
- sendMessage(message): 发送游戏消息
- disconnect(): 断开连接
```

#### 3. 多人游戏逻辑 (`src/hooks/useMultiplayerGame.ts`)
**功能：**
- 扩展单人游戏逻辑支持多人模式
- 处理回合制约束（只能在自己回合下棋）
- 同步游戏状态
- 处理对手消息

**核心特性：**
- 房主执黑子（先手），客人执白子（后手）
- 只允许在自己回合下棋
- 实时同步棋盘状态
- 悔棋需要撤销双方各一步

#### 4. 房间大厅界面 (`src/components/RoomLobby.tsx`)
**功能：**
- 显示用户ID和连接状态
- 创建房间或输入房间ID加入
- 显示玩家角色（房主/客人，黑子/白子）
- 连接状态指示器

#### 5. 多人游戏页面 (`src/app/multiplayer/page.tsx`)
**功能：**
- 集成房间大厅和游戏界面
- 管理游戏流程（大厅 → 游戏 → 结果）
- 显示多人专属控制面板
- 回合提示和权限控制

#### 6. 主菜单升级 (`src/app/page.tsx`)
**功能：**
- 游戏模式选择（单人/多人）
- 模式间切换
- 游戏规则说明

### 游戏流程

#### 房间创建流程
1. 用户点击"创建房间" 
2. 系统生成6位随机房间号（如：123456）
3. 使用 `room-123456` 作为PeerJS的peerId
4. 房主等待客人加入，显示6位房间号供分享
5. 房主执黑子，具有开始游戏权限

#### 房间加入流程  
1. 用户输入6位房间号（如：123456）
2. 系统验证格式后连接到 `room-123456` 对应的PeerJS实例
3. 连接成功后成为客人，执白子
4. 双方显示相同的6位房间号，等待房主开始游戏

#### 游戏进行流程
1. 房主开始游戏，双方进入游戏界面
2. 黑子（房主）先手
3. 每次下棋后发送move消息给对手
4. 系统验证回合正确性和棋步有效性
5. 实时同步棋盘状态

#### 消息传递协议
```typescript
// 下棋消息
{
  type: 'move',
  data: { row: number, col: number, player: 'black'|'white' },
  timestamp: number,
  playerId: string
}

// 重新开始
{
  type: 'restart',
  data: {},
  timestamp: number,
  playerId: string  
}

// 悔棋（撤销双方各一步）
{
  type: 'undo', 
  data: {},
  timestamp: number,
  playerId: string
}
```

### 技术亮点

1. **轻量级架构**: 无后端依赖，仅用PeerJS实现实时通信
2. **简化房间号**: 使用6位数字房间号，便于记忆和分享
3. **状态同步**: 确保双方游戏状态完全一致  
4. **回合制控制**: 严格的回合验证，防止非法操作
5. **连接管理**: 自动处理连接状态，用户友好的错误提示
6. **权限分离**: 房主和客人有不同的操作权限
7. **实时反馈**: 连接状态、回合提示、游戏进度实时显示
8. **输入验证**: 房间号格式验证，只允许6位纯数字

### 部署特性
- 完全兼容静态网站部署
- 可部署到 GitHub Pages、Netlify、Vercel 等平台
- 无需额外的服务器资源
- 支持HTTPS环境下的WebRTC连接

### 使用限制和建议

#### P2P连接限制
由于WebRTC和PeerJS的技术特性，存在以下使用限制：

1. **同浏览器限制**: 无法在同一浏览器的不同标签页间建立P2P连接
2. **测试建议**: 
   - 使用不同浏览器 (Chrome + Firefox)
   - 使用隐私/无痕模式
   - 使用不同设备进行测试

#### 最佳实践
- 🌐 **生产环境**: 不同用户自然使用不同设备/浏览器，无此限制
- 🧪 **本地测试**: 建议使用两个不同浏览器进行功能验证
- 📱 **移动端**: 支持手机浏览器，可与桌面端互联
- 🔒 **网络环境**: 在企业防火墙或严格NAT环境下可能需要额外配置
